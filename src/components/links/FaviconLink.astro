---
import BaseIconLink from "./_BaseIconLink.astro";
interface Props {
    href: string;
    class?: string;
    showIcon?: boolean;
}

const {
    href:faviconHref,
    class:className = "",
    showIcon = true,
    ...rest } = Astro.props;

const faviconDomain = new URL(faviconHref).hostname;
const faviconUrls = [
    `https://${faviconDomain}/favicon.ico`,
    `https://api.faviconkit.com/${faviconDomain}/16`,
    `https://icons.duckduckgo.com/ip3/${faviconDomain}.ico`,
    `https://www.google.com/s2/favicons?sz=16&domain=${faviconDomain}`
];

import toSafeId from "../../scripts/toSafeId.ts";

const faviconImgId = toSafeId('link-favicon-img');

console.log('faviconUrls', faviconUrls); // DO NOT REMOVE!
console.log('faviconDomain', faviconDomain);

---

<BaseIconLink href={faviconHref}
              class=`highlight-link ${className}`
              title="Open External Link..."
              showIcon={showIcon}
              {...rest}>

    <slot slot="link-content"/>

    <img slot="link-icon" id={faviconImgId} src="" alt={faviconHref} width="16" height="16" class="w-4 h-4 inline relative -top-0.5" />
</BaseIconLink>


<script is:inline define:vars={{showIcon, faviconImgId, faviconHref, faviconUrls}} data-astro-rerun>
    function setFaviconImg() {
        const img = document.getElementById(faviconImgId);
        function tryNext(index) {
            if (index >= faviconUrls.length) {
                // No more fallbacks available
                console.warn(`favicon (${faviconHref}) FAILED!`)
                img.classList.remove('inline');
                img.classList.add('hidden');

                return;
            }

            const testImage = new Image();
            testImage.src = faviconUrls[index];
            console.warn(`Trying favicon (${faviconUrls[index]})`);
            testImage.onload = () => {
                // Use this favicon if it loads
                console.warn(`Using favicon (${faviconUrls[index]})`);
                img.src = faviconUrls[index];

            }
            testImage.onerror = () => {
                // Try next option on error
                tryNext(index + 1);
            }
        }

        tryNext(0); // Start trying from the first favicon option
    }
    if (showIcon) {
        console.warn(`Setting favicon (${faviconHref})`);
        setFaviconImg();
    }
</script>
