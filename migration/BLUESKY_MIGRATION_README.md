# Bluesky Post URL Migration

This directory contains tools for migrating existing Bluesky posts to include human-readable web URLs.

## Files

- **migrate_bluesky_urls.py**: Migration script to add `post_url` field to existing entries in `bluesky_posted.json`
- **post_to_bluesky.py**: Updated to automatically include `post_url` when posting new content to Bluesky

## What Changed

Each entry in `bluesky_posted.json` now includes:
- `post_id`: Local file path (unchanged)
- `post_uri`: ATProto URI like `at://did:plc:xxx/app.bsky.feed.post/rkey` (unchanged)
- `post_cid`: Content identifier (unchanged)
- **`post_url`**: Human-readable Bluesky web URL like `https://bsky.app/profile/handle/post/rkey` (**NEW**)
- **`profile_id`**: Bluesky handle like `hiivelabs.com` or `kojika.bsky.social` (**NEW**)

## How It Works

The `post_url` and `profile_id` are generated by:
1. Parsing the DID from `post_uri`
2. Querying `https://plc.directory/{did}` to resolve the DID to a handle (cached to avoid repeated queries)
3. Storing the handle as `profile_id`
4. Extracting the rkey from `post_uri`
5. Constructing `post_url`: `https://bsky.app/profile/{handle}/post/{rkey}`

## Usage

### Migrate Existing Data

```bash
python migrate_bluesky_urls.py src/assets/_private/state/hiivelabs.com/bluesky_posted.json
```

### New Posts

Future posts will automatically include the `post_url` field when created via `post_to_bluesky.py`.

## Known Issues

### PLC Directory Blocking

The PLC directory (https://plc.directory) may block requests from certain environments or IPs with a 403 Forbidden error. If you encounter this:

1. **Try from a different environment**: Run the migration script from your local machine or a different server
2. **Manual alternative**: Manually construct URLs using the format:
   ```
   https://bsky.app/profile/{handle}/post/{rkey}
   ```
   Where you can find your handle on your Bluesky profile and the rkey is the last part of the `post_uri`

### Example Manual Migration

If automated migration fails, you can manually add `post_url` and `profile_id` to each entry:

```json
{
  "post_id": "posts/hiivelabs.com/2025-01-06-cellular-automata.mdx",
  "post_uri": "at://did:plc:uxb4wvzgll6c47yxxpyqlib7/app.bsky.feed.post/3lf4sdvgkez25",
  "post_cid": "bafyreidtb6dvehh5ubw7f7wooa6wxjy5fo4l5miubyvov227j63asrskhu",
  "post_url": "https://bsky.app/profile/YOUR_HANDLE/post/3lf4sdvgkez25",
  "profile_id": "YOUR_HANDLE"
}
```

## Technical Details

- Uses `requests` library for PLC directory queries
- **Caches DID â†’ handle mappings** to avoid repeated API calls (important for bulk operations)
- Includes error handling for network failures and malformed responses
- Future posts automatically include `post_url` and `profile_id` without manual intervention

## Dependencies

Make sure `requests` is installed:
```bash
pip install requests
```
